 <ons-page>
    <ons-toolbar>
        <div class="left">
            <ons-toolbar-button>
                <ons-back-button>Back</ons-back-button>
            </ons-toolbar-button>
        </div>
        <div class="center" id="title">
            Таблица
        </div>
    </ons-toolbar>
    <div id="features-list"></div>
    <script>
        var layerID
        var left_row, right_row
        var count_row
        var limit = 50
        var offset = 0
        ons.getScriptPage().onInit = function() {
            layerID = this.data.layerID

            getDataFromDB(`SELECT COUNT(*) as count FROM ${layerID}`, function(data){
                count_row = data.rows.item(0).count
            })
            
            var layer = findLayer(layerID)
            let table = "<table class='features'>" +
                "<thead>" + 
                    "<tr>" + 
                        `<th>
                            <ons-select onchange="editFeaturesTable(event)">
                                <select class="feat_left">`
                                for(atrib of layer.atribs){
                                    table += `<option value="${atrib.name}">${atrib.label}</option>`
                                }
                            table += `</select>
                            </ons-select>
                        </th>` + 
                        `<th>
                            <ons-select onchange="editFeaturesTable(event)">
                                <select class='feat_right'>`
                                for(atrib of layer.atribs){
                                    table += `<option value="${atrib.name}">${atrib.label}</option>`
                                }
                            table += `</select>
                            </ons-select>
                        </th>` + 
                    "</tr>" +
                "</thead>" + 
                "<tbody id='features-tbody'>" +
                "</tbody>" + 
            "</table>"
            var content = document.getElementById("features-list");
            content.innerHTML = table
            document.getElementById("title").innerHTML = layer.label
            left_row = layer.atribs[0].name
            right_row = layer.atribs[1].name
            document.getElementsByClassName("feat_right")[0].value = right_row
            showFeaturesList(layerID, left_row, right_row, limit, offset)

            this.querySelector('.page__content').addEventListener('scroll',  function (e) {
                checkPosition()
            });
            
        };

        function getPropertyPage(featureID){
            document.querySelector('#myNavigator').pushPage('./views/featureProperties.html', {data: {layerID: layerID, featureID: featureID}});
        }

        function editFeaturesTable(event){
            offset = 0
            let divClass = event.target.className
            divClass = divClass.split(" ")[0]
            if(divClass == 'feat_left'){
                left_row = event.target.value
            }
            else if(divClass == 'feat_right'){
                right_row = event.target.value
            }
            let table = document.querySelector('#features-tbody')
            table.innerHTML = ""
            showFeaturesList(layerID, left_row, right_row, limit, offset)
        }

        function checkPosition(){
            const height = document.body.offsetHeight
            const screenHeight = window.innerHeight
            const scrolled = window.scrollY
            const threshold = height - screenHeight
            const position = scrolled + screenHeight

            if (position >= threshold) {
                offset += limit
                if(offset > count_row){
                    return
                }
                showFeaturesList(layerID, left_row, right_row, limit, offset)
            }
        }

        function showFeaturesList(layerID, left_row, right_row, limit, offset){
            let layer = findLayer(layerID)
            const query = `SELECT  ${layer.atribs[0].name} as id, ${left_row} as left, ${right_row} as right from ${layerID} LIMIT ${limit} OFFSET ${offset}`
            getDataFromDB(query, function(data){
                let table = document.querySelector('#features-tbody')
                for(let i = 0; i < data.rows.length; i++){
                    let line = document.createElement("tr")
                    let line_content = `<td><div>${getValueFromLayerAtrib(layerID, left_row, data.rows.item(i).left)}</div></td>
                                        <td><div>${getValueFromLayerAtrib(layerID, right_row, data.rows.item(i).right)}</div></td>`
                    line.innerHTML = line_content
                    line.addEventListener('click', () => getPropertyPage(data.rows.item(i).id))
                    table.append(line)
                }
            })
        }


    </script>
</ons-page>