<ons-page>
    <ons-toolbar>
        <div class="left">
            <ons-toolbar-button>
                <ons-back-button>Back</ons-back-button>
            </ons-toolbar-button>
        </div>
        <div class="center" id="title">
            Таблица
        </div>
    </ons-toolbar>
    <div id="features-list"></div>
    <script>
        var layerID
        ons.getScriptPage().onInit = function() {
            layerID = this.data.layerID
            var layer = findLayer(layerID)
            getDataFromDB(`SELECT ${layer.atribs[0].name}, ${layer.atribs[1].name} from ` + layerID + " LIMIT 50", function(data){
                let table = "<table class='features'>" +
                    "<thead>" + 
                        "<tr>" + 
                            `<th>
                                <ons-select onchange="editFeaturesTable(event)">
                                    <select class="feat_left">`
                                    for(atrib of layer.atribs){
                                        table += `<option value="${atrib.name}">${atrib.label}</option>`
                                    }
                                table += `</select>
                                </ons-select>
                            </th>` + 
                            `<th>
                                <ons-select onchange="editFeaturesTable(event)">
                                    <select class='feat_right'>`
                                    for(atrib of layer.atribs){
                                        table += `<option value="${atrib.name}">${atrib.label}</option>`
                                    }
                                table += `</select>
                                </ons-select>
                            </th>` + 
                        "</tr>" +
                    "</thead>" + 
                    "<tbody>"
                for(let i = 0; i < data.rows.length; i++){
                    table += `<tr onClick=getPropertyPage('${data.rows.item(i)[layer.atribs[0].name]}')>` + 
                        `<td><div class='feat_left'>${data.rows.item(i)[layer.atribs[0].name]}</div></td>` + 
                        `<td><div class='feat_right'>${data.rows.item(i)[layer.atribs[1].name]}</div></td>`+
                        "</tr>"
                }
                table += "</tbody></table>"
                
                var content = document.getElementById("features-list");
                content.innerHTML = table
                document.getElementById("title").innerHTML = layer.label
                document.getElementsByClassName("feat_right")[0].value = layer.atribs[1].name
            })
            
        };

        function getPropertyPage(featureID){
            document.querySelector('#myNavigator').pushPage('./views/featureProperties.html', {data: {layerID: layerID, featureID: featureID}});
        }

        function editFeaturesTable(event){
            var layer = findLayer(layerID)
            let divClass = event.target.className
            divClass = divClass.split(" ")[0]
            getDataFromDB(`SELECT ${event.target.value} as label from ` + layerID + " LIMIT 50", function(data){
                let rows = document.getElementsByClassName(divClass)
                switch(getTypeByAtribName(layer.atribs, event.target.value)){
                    case "BOOLEAN":
                        for(let i = 0; i < data.rows.length; i++){
                            if(typeof data.rows.item(i).label == 'undefined'){
                                rows[i + 1].innerHTML = " "
                            }
                            else if(data.rows.item(i).label === 1){
                                rows[i + 1].innerHTML = "Да"
                            }
                            else{
                                rows[i + 1].innerHTML = "Нет"
                            }
                        }
                        break
                    case "DATE":
                        for(let i = 0; i < data.rows.length; i++){
                            if(data.rows.item(i).label === 0 || typeof data.rows.item(i).label == 'undefined'){
                                    rows[i + 1].innerHTML = " "
                            }
                            else{
                                rows[i + 1].innerHTML = `${new Date(data.rows.item(i).label).toLocaleString()}`
                            }
                            }
                        break
                    default:
                        for(let i = 0; i < data.rows.length; i++){
                            if(typeof data.rows.item(i).label == 'undefined'){
                                rows[i + 1].innerHTML = " "
                            }
                            else{
                                rows[i + 1].innerHTML = data.rows.item(i).label
                            }
                        }
                }
            })
        }

    </script>
</ons-page>