<ons-page>
    <ons-toolbar>
        <div class="left">
            <ons-toolbar-button>
                <ons-back-button>Back</ons-back-button>
            </ons-toolbar-button>
        </div>
        <div class="center" id="title">
            Панель свойств объекта
        </div>
    </ons-toolbar>
    <div id="local-map"></div>
    <div id="table"></div>
    <script>
                var raster = new ol.layer.Tile({
                    source: new ol.source.OSM({})
                });
                var local_map = new ol.Map({
                    target: 'local-map',
                    controls: [],
                    interactions: [],
                    layers: [raster]
                });
        ons.getScriptPage().onInit = function() {
            var layer = findLayer(this.data.layerID)
            const query = "SELECT " + layer.atribs.join(', ') + " from " + this.data.layerID + 
            " WHERE id = " + this.data.featureID
            getDataFromDB(query, function(data){
                var table = "<table>" 
                for(let i = 0; i < layer.atribs.length; i++){
                    table += "<tr>" + 
                        `<td class='title'>${layer.atribs_label[i]}</td>`
                    if(layer.atribs_type[i] == "BOOLEAN"){
                        table += `<td class='checkbox'><ons-checkbox value=${layer.atribs} disabled`
                        if(data.rows.item(0)[layer.atribs[i]] === 1){
                            table += " checked "
                        }
                        table += `></td>`
                    }
                    else if(layer.atribs_type[i] == "DATE"){
                        let date_insp = data.rows.item(0)[layer.atribs[i]]
                        if(date_insp !== 0 && typeof date_insp !== 'undefined'){
                            table += `<td class='content'>${new Date(date_insp).toLocaleString() }</td>`
                        }
                    }
                    else{
                        table += `<td class='content'>${data.rows.item(0)[layer.atribs[i]]}</td>`
                    }
                        table += "</tr>"
                }
                table += "</table>"
                var content = document.getElementById("table");
                content.innerHTML = table
            })
            const queryMap = "SELECT AsText(Geometry) as geom from " + this.data.layerID +
             " WHERE id = "  + this.data.featureID
            getDataFromDB(queryMap, function(data){
                
                const format = new ol.format.WKT();
                var wkt = data.rows.item(0).geom
                var feature = format.readFeature(wkt.replaceAll("nan", "0"))
                var source = new ol.source.Vector()
                source.addFeature(feature)
                var clonedLayer = new ol.layer.Vector({
                    style: layer.getStyle()
                });
                clonedLayer.setSource(source)
                local_map.addLayer(clonedLayer)
                local_map.setView(new ol.View({
                    center: feature.getGeometry().getClosestPoint([0,0]),
                    zoom: 10
                }))
            })
        }

        function findLayer(layerID){
            for(layer of layers){
                if(layer.id == layerID){
                    return layer
                }
            }
            return null
        }
    </script>
    <style>
  		table {
            width: 100%;  
            border-collapse: separate;
            border-spacing: 20;
        }
        .title {
        	width: 20%;
            text-align: right; 
            font-weight: bold;
        }
        .content {
        	width: 70%;
        }
        .checkbox {
            width: 70%;
            text-align: center; 
            vertical-align: middle;
        }
        #local-map {
            margin: 0;
            height: 30%;
            width: 100%;
            font-family: sans-serif;
        }
    </style>
</ons-page>