<ons-page>
    <ons-toolbar>
        <div class="left">
            <ons-toolbar-button>
                <ons-back-button>Back</ons-back-button>
            </ons-toolbar-button>
        </div>
        <div class="center" id="title">
            Панель свойств объекта
        </div>
    </ons-toolbar>
    <div id="featureProperties" class="page-content">
        <div id="local-map"></div>
        <div id="table"></div>
    </div>

    <ons-carousel direction="horizontal" item-width="25%" swipeable id="feature-instruments">
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-map">
                <ons-icon icon="md-map"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-edit">
                <ons-icon icon="md-edit"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-edit-geometry">
                <ons-icon icon="md-border-color"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-delete">
                <ons-icon icon="md-delete"></ons-icon>
            </div>
        </ons-carousel-item>
    </ons-carousel>

    <script>

        ons.getScriptPage().onInit = function() {
            let clone_raster = new ol.layer.Tile({source: raster.getSource()})
            var local_map = new ol.Map({
                    target: 'local-map',
                    controls: [],
                    interactions: [],
                    layers: [clone_raster]
                });
            let feature = this.data.feature
            let layer = findLayer(feature.layerID)
            let atribs = []
            for(atrib of layer.atribs){
                atribs.push(atrib.name)
            }
            let query = "SELECT AsText(Geometry) as geom, " + atribs.join(', ') + " from " + layer.id + 
            " WHERE id = " + feature.id
            requestToDB(query, function(data){
                var table = "<table>" 
                for(atrib of layer.atribs){
                    if(checkServiceField(atrib.name)){
                        continue
                    }
                    table += "<tr>" + 
                        `<td class='title'>${atrib.label}</td>`
                    if(atrib.type == "BOOLEAN"){
                        table += `<td class='content checkbox'><ons-checkbox value=${atrib.name} disabled`
                        if(data.rows.item(0)[atrib.name] === 1){
                            table += " checked "
                        }
                        table += `></td>`
                    }
                    else if(atrib.type == "DATE"){
                        let date_insp = data.rows.item(0)[atrib.name]
                        if(date_insp !== 0 && typeof date_insp !== 'undefined'){
                            table += `<td class='content'>${new Date(date_insp).toLocaleString() }</td>`
                        }
                    }
                    else{
                        if(typeof data.rows.item(0)[atrib.name] == 'undefined'){
                            table +=  `<td class='content'></td>`
                        }
                        else{
                            table += `<td class='content'>${data.rows.item(0)[atrib.name]}</td>`
                        }
                    }
                        table += "</tr>"
                }
                table = addMetricCharacter(layer, table, data.rows.item(0).geom)
                table += "</table>"
                var content = document.getElementById("table");
                content.innerHTML = table
            })

            displayLocalMap()

            document.querySelector('#feature-instrument-map').addEventListener('click', centerOnCurrentFeature, false)
            document.querySelector('#feature-instrument-delete').addEventListener('click', clickDeleteFeature, false)


            function displayLocalMap(){
                let source = new ol.source.Vector()
                source.addFeature(feature)
                let clonedLayer = new ol.layer.Vector({
                    style: layer.getStyle()
                });
                clonedLayer.setSource(source)
                local_map.addLayer(clonedLayer)
                local_map.setView(new ol.View({
                    center: feature.getGeometry().getClosestPoint([0,0]),
                    zoom:  currentMapView.getMaxZoom()
                }))

                local_map.on('click', function(evt){
                    centerOnCurrentFeature()
                })
            }

            function addMetricCharacter(layer, table, geom){
                const format = new ol.format.WKT();
                let wkt = geom
                let feature = format.readFeature(wkt.replace(/nan/g, "0"))
                let geometry = feature.getGeometry()
                switch(layer.geometryType){
                    case "MULTIPOINT":
                        table += `<td class='title'>Координаты точки</td>`
                        let coords = geometry.getCoordinates()
                        let str = coords.toString()
                        let arr = str.split(',')
                        let lonlat = ol.proj.toLonLat([parseInt(arr[0]), parseInt(arr[1])]);
                        table += `<td class='content'>${lonlat}</td>`
                        break
                    case 'MULTILINESTRING':
                        table += `<td class='title'>Длина линии</td>`
                        table += `<td class='content'>${ol.sphere.getLength(geometry)}</td>`
                        break
                    case 'MULTIPOLYGON':
                        table += `<td class='title'>Площадь</td>`
                        table += `<td class='content'>${ol.sphere.getArea(geometry)}</td>`
                        break
                }
                return table
            }

            function centerOnCurrentFeature(){
                centerOnFeature(feature.getGeometry().getClosestPoint([0,0]))
            }

            function centerOnFeature(center){
                let navigator = document.querySelector('#myNavigator')
                currentMapView.setCenter(center)
                currentMapView.setZoom(currentMapView.getMaxZoom())
                navigator.popPage({times: navigator.pages.length - 1})
            }

            function clickDeleteFeature(){
                ons
                .notification.confirm({title: 'Удаление', message: 'Вы уверены, что хотите удалить элемент?'})
                .then(function(index) {
                    if(index == 1)
                        deleteCurrentFeature()
                });
            }

            function deleteCurrentFeature(){
                const query = `DELETE FROM ${feature.layerID} WHERE id='${feature.id}';`
                requestToDB(query, function(res){
                    layer.getSource().removeFeature(feature)

                    let navigator = document.querySelector('#myNavigator')
                    navigator.popPage({times: navigator.pages.length - 1})
                })
            }

        }

    </script>
</ons-page>