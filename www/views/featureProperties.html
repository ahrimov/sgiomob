<ons-page>
    <ons-toolbar>
        <div class="left">
            <ons-toolbar-button>
                <ons-back-button>Back</ons-back-button>
            </ons-toolbar-button>
        </div>
        <div class="center" id="title">
            Панель свойств объекта
        </div>
    </ons-toolbar>
    <div id="featureProperties" class="page-content">
        <div id="local-map"></div>
        <div id="table"></div>
    </div>

    <ons-carousel direction="horizontal" item-width="25%" swipeable id="feature-instruments">
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-map">
                <ons-icon icon="md-map"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-edit">
                <ons-icon icon="md-edit"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-edit-geometry">
                <ons-icon icon="md-border-color"></ons-icon>
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="feature-instrument-delete">
                <ons-icon icon="md-delete"></ons-icon>
            </div>
        </ons-carousel-item>
    </ons-carousel>

    <div class="under-bar">
        <ons-button id='saveModificationFeature' style="float:right; margin: 1%;">Сохранить</ons-button>
        <ons-button id="cancelModification" style="float:right; margin: 1%;">Отмена</ons-button>
      </div>

    <script>

        ons.getScriptPage().onInit = function() {
            let clone_raster = new ol.layer.Tile({source: raster.getSource()})
            var local_map = new ol.Map({
                    target: 'local-map',
                    controls: [],
                    interactions: [],
                    layers: [clone_raster]
                });
            let feature = this.data.feature
            let layer = findLayer(feature.layerID)
            let atribs = []
            let values = []
            for(atrib of layer.atribs){
                if(checkServiceField(atrib.name)){
                    continue
                }
                atribs.push(atrib.name)
            }
            let query = "SELECT AsText(Geometry) as geom, " + atribs.join(', ') + " from " + layer.id + 
            " WHERE id = " + feature.id
            requestToDB(query, function(data){
                var table = "<table>" 
                for(atrib of layer.atribs){
                    if(checkServiceField(atrib.name)){
                        continue
                    }
                    table += `<tr>
                        <td class='title'>${atrib.label}</td>
                        <td class='content'>${contentByType(atrib, data.rows.item(0)[atrib.name])}
                        </tr>`
                    
                    values.push(data.rows.item(0)[atrib.name])
                }
                table = addMetricCharacter(layer, table, data.rows.item(0).geom)
                table += "</table>"
                var content = document.getElementById("table");
                content.innerHTML = table
            })

            displayLocalMap()

            document.querySelector('#feature-instrument-map').addEventListener('click', centerOnCurrentFeature, false)
            document.querySelector('#feature-instrument-edit').addEventListener('click', clickEditFeature, false)
            document.querySelector('#feature-instrument-delete').addEventListener('click', clickDeleteFeature, false)

            document.querySelector('#saveModificationFeature').addEventListener('click', updateFeature, false)
            document.querySelector('#cancelModification').addEventListener('click', cancel, false)


            function contentByType(atrib, content){
                switch(atrib.type){
                case 'DATE':
                    let date_insp = content
                    if(date_insp !== 0 && typeof date_insp !== 'undefined'){
                        return new Date(date_insp).toLocaleString()
                    }
                case 'BOOLEAN':
                    let check = ''
                    if(content === 1)
                        check = 'checked'
                    return `<ons-checkbox id='${atrib.name}' ${check}  disabled></ons-checkbox>`
                default:
                    if(typeof content == 'undefined')
                        return ''
                    return content
                }
            }


            function inputByType(atrib, content){
                switch(atrib.type){
                case 'DOUBLE':
                    if(typeof content == 'undefined')
                        return `<ons-input id='${atrib.name}' class='input-content' modifier="underbar" type="number" float></ons-input>`
                    return `<ons-input id='${atrib.name}' class='input-content' value='${content}' modifier="underbar" type="number" float  ></ons-input>`
                case 'DATE':
                    if(typeof content == 'undefined')
                        return `<ons-input id='${atrib.name}' class='input-content' modifier="underbar" type="date" float></ons-input>`
                    return `<ons-input id='${atrib.name}' class='input-content' value='${content}' modifier="underbar" type="date" float  ></ons-input>`
                case 'BOOLEAN':
                    let check = ''
                    if(content === 1)
                        check = 'checked'
                    return `<ons-checkbox id='${atrib.name}' ${check}  ></ons-checkbox>`
                case 'ENUM':
                    let select = `<ons-select id='${atrib.name}' class='input-content' value='${content}'>`
                    for(let option of atrib.options){
                        select += `<option value='${option}'>${option}</option>`
                    }
                    select += `</ons-select>`
                    return select
                default:
                    if(typeof content == 'undefined')
                        return `<ons-input id='${atrib.name}' class='input-content' modifier="underbar" float></ons-input>`
                    return `<ons-input id='${atrib.name}' class='input-content' value='${content}' modifier="underbar" float></ons-input>`
                }
            }

            function displayLocalMap(){
                let source = new ol.source.Vector()
                source.addFeature(feature)
                let clonedLayer = new ol.layer.Vector({
                    style: layer.getStyle()
                });
                clonedLayer.setSource(source)
                local_map.addLayer(clonedLayer)
                local_map.setView(new ol.View({
                    center: feature.getGeometry().getClosestPoint([0,0]),
                    zoom:  currentMapView.getMaxZoom()
                }))

                local_map.on('click', function(evt){
                    centerOnCurrentFeature()
                })
            }

            function addMetricCharacter(layer, table, geom){
                const format = new ol.format.WKT();
                let wkt = geom
                let feature = format.readFeature(wkt.replace(/nan/g, "0"))
                let geometry = feature.getGeometry()
                switch(layer.geometryType){
                    case "MULTIPOINT":
                        table += `<td class='title'>Координаты точки</td>`
                        let coords = geometry.getCoordinates()
                        let str = coords.toString()
                        let arr = str.split(',')
                        let lonlat = ol.proj.toLonLat([parseInt(arr[0]), parseInt(arr[1])]);
                        table += `<td class='metric'>${lonlat}</td>`
                        break
                    case 'MULTILINESTRING':
                        table += `<td class='title'>Длина линии</td>`
                        table += `<td class='metric'>${ol.sphere.getLength(geometry)}</td>`
                        break
                    case 'MULTIPOLYGON':
                        table += `<td class='title'>Площадь</td>`
                        table += `<td class='metric'>${ol.sphere.getArea(geometry)}</td>`
                        break
                }
                return table
            }

            function centerOnCurrentFeature(){
                centerOnFeature(feature.getGeometry().getClosestPoint([0,0]))
            }

            function centerOnFeature(center){
                let navigator = document.querySelector('#myNavigator')
                currentMapView.setCenter(center)
                currentMapView.setZoom(currentMapView.getMaxZoom())
                navigator.popPage({times: navigator.pages.length - 1})
            }

            function clickEditFeature(){
                let content = document.querySelectorAll('.content')
                for(let index in values){
                    content[index].innerHTML = inputByType(layer.atribs[index], values[index])
                }
                document.querySelector('#feature-instruments').style['display'] = 'none'
                document.querySelector('.under-bar').style['display'] = 'block'
            }

            function clickDeleteFeature(){
                ons
                .notification.confirm({title: 'Удаление', message: 'Вы уверены, что хотите удалить элемент?'})
                .then(function(index) {
                    if(index == 1)
                        deleteCurrentFeature()
                });
            }

            function deleteCurrentFeature(){
                const query = `DELETE FROM ${feature.layerID} WHERE id='${feature.id}';`
                requestToDB(query, function(res){
                    layer.getSource().removeFeature(feature)

                    let navigator = document.querySelector('#myNavigator')
                    navigator.popPage({times: navigator.pages.length - 1})
                })
            }

            function updateFeature(){
                let updates = []
                let input_content = document.querySelectorAll('.input-content')
                for(let index in values){
                    values[index] = input_content[index].value
                    if(values[index] == '')
                        continue
                    updates.push(`${atribs[index]} = '${values[index]}'`)
                }
                const query = `UPDATE ${layer.id } SET ${updates.join(', ')} WHERE ${layer.atribs[0].name} = ${feature.id}`
                console.log(query)
                requestToDB(query, function(res){
                    feature.id = values[0]
                })
                cancel()
            }

            function cancel(){
                let input_content = document.querySelectorAll('.input-content')
                for(let index in values){
                    input_content[index].remove()
                }
                let content = document.querySelectorAll('.content')
                for(let index in values){
                    content[index].innerHTML = contentByType(layer.atribs[index], values[index])
                }
                document.querySelector('.under-bar').style['display'] = 'none'
                document.querySelector('#feature-instruments').style['display'] = 'block'
            }
        }

    </script>
</ons-page>