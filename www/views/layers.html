<ons-page>
    <ons-toolbar>
      <div class="left">
        <ons-toolbar-button>
            <ons-back-button>Back</ons-back-button>
        </ons-toolbar-button>
      </div>
      <div class="center">
        Слои
      </div>
    </ons-toolbar>

    <div id="layerListWithHandle" class="list-group">
    </div>

    <ons-list-item expandable>
      <span class="layers-label">Карта OSM</span>
      <div class="expandable-content">
        <ons-switch id="raster-layer-switch"></ons-switch>
          Использовать локальные тайлы
          </br>
          <ons-switch id="raster-layer-switch-visible"></ons-switch>
          <span>Показывать подложку</span>
        </div>
    </ons-list-item>

    <template id="layerListItem">
      <div class="list-group-item" onclick="changeVisible(this)">
        <ons-icon icon="md-reorder" class="reorder-move" size="150%"></ons-icon>
            <span class="layers-label"></span>
            <ons-icon class='block-icon' icon='md-block'></ons-icon>
            <ons-button modifier="quiet" class="layers-more-button" onclick="showActionSheet(this, event)">
              <ons-icon icon='md-more-vert'></ons-icon>
            </ons-button>
        </div>
    </template>

    <template id="file_chooser">
      <ons-dialog id="file-chooser">
              <ons-toolbar class="dialog-toolbar">
                  <div class="center dialog-toolbar-content">
                      Выберите файл KML
                  </div>
                  <div class="right">
                      <ons-toolbar-button onclick="hideDialog('file-chooser')">
                          <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                      </ons-toolbar-button>
                  </div>
              </ons-toolbar>
              <div> 
              <ons-list id="dialog-file-chooser-content">
              </ons-list>
              </div>
      </ons-dialog>
  </template>

  <template id="comparison_KML">
    <ons-dialog id="comparison-KML">
            <ons-toolbar class="dialog-toolbar">
                <div class="center dialog-toolbar-content">
                    Сопоставление атрибутов
                </div>
                <div class="right">
                    <ons-toolbar-button onclick="hideDialog('comparison-KML')">
                        <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>
            <div id="dialog-comparison-KML-content">
                <p>Соотнесите служебные имена характеристик в левой части (атрибуты из панели свойств)
                     и имена характеристик в правой (полученные из импортируемого Вами файла)</p>
                <div id="dialog-list-properties">
                </div>
                <ons-button modifier="quiet" id="acceptImportKML" style="float:right;">Применить</ons-button>
                <ons-button modifier="quiet" onclick="hideDialog('comparison-KML')" style="float:right;">Отмена</ons-button>
            </div>
    </ons-dialog>
</template>

<template id="choose_path_to_KML">
  <ons-dialog id="choose-path-to-KML">
    <ons-toolbar class="dialog-toolbar">
      <div class="center dialog-toolbar-content">
          Выберите путь к KML
      </div>
      <div class="right">
          <ons-toolbar-button onclick="hideDialog('choose-path-to-KML')">
              <ons-icon icon="md-close" class="dialog-close"></ons-icon>
          </ons-toolbar-button>
      </div>
    </ons-toolbar>
    <ons-list id="path-chooser-KML">
      <ons-list-item tappable>
        <label class="left">
          <ons-radio name="pathToKML" input-id="media" id="media-path" checked></ons-radio>
        </label>
        <label for="media" class="center">
          Android/media/io.cordova.sgiomob/KML
        </label>
      </ons-list-item>
      <ons-list-item tappable>
        <label class="left">
          <ons-radio name="pathToKML" input-id="iternal" id="iternal-path"></ons-radio>
        </label>
        <label for="iternal" class="center">
          Android/data/io.cordova.sgiomob/Project/KML
        </label>
      </ons-list-item>
    </ons-list>
    <ons-button modifier="quiet" id="buttonFileChooser" style="float:right;">Далее</ons-button>
  </ons-dialog>
</template>

    <script>
      var app = {}
        ons.getScriptPage().onInit = function() {
          var list = document.querySelector("#layerListWithHandle")
          var template = document.querySelector('#layerListItem')
          layers.sort(function(a, b){
            return b.getZIndex() - a.getZIndex()
          })
          for(layer of layers){
            let label = clipping(layer.label, 30)
            
            var item = template.content.cloneNode(true)
            item.querySelector('.layers-label').textContent = label
            item.querySelector('.list-group-item').setAttribute("data-id", layer.id)
            item.querySelector('.layers-more-button').setAttribute("layer_id", layer.id)
            if(layer.enabled){
              item.querySelector('.block-icon').style['display'] = 'none';
            }
            if(layer.getVisible()){
              item.querySelector('.list-group-item').style.backgroundColor = '#2375fa'
            }
            list.appendChild(item)
          }

          if(typeof localSource == 'undefined'){
            document.querySelector('#raster-layer-switch').setAttribute('disabled', 'true')
          }

          if(raster.isLocal){
            document.querySelector('#raster-layer-switch').setAttribute('checked', 'true')
          }
              
          document.querySelector('#raster-layer-switch').addEventListener('change', function(){
            raster.isLocal = !raster.isLocal
            if(raster.isLocal){
              raster.setSource(localSource)
            }
            else{
              raster.setSource(new ol.source.OSM({}))
            }
            updateInfo()
          })

          if(raster.visible){
            document.querySelector('#raster-layer-switch-visible').setAttribute('checked', 'true')
          }

          document.querySelector('#raster-layer-switch-visible').addEventListener('change', function(){
            raster.visible = !raster.visible
            raster.setVisible(raster.visible)
          })
        }

        function changeVisible(element){
          var layerID = element.getAttribute("data-id");
          for(layer of layers){
            if(layer.id == layerID){
              if(layer.visible == layer.getVisible()){
                layer.visible = !layer.visible;
                layer.setVisible(layer.visible);
              }
              else{
                ons.notification.alert({title:"Внимание", meassage:'Слой невозможно отобразить.'})
              }
              if(layer.getVisible()){
                element.style.backgroundColor = '#2375fa';
              }
              else{
                element.style.backgroundColor = '#FFFFFF';
              }
            }
          }
        }

        function createFileChooserForKML(layerID, callback){
          ons.createElement('choose_path_to_KML', {append: true})
                  .then(function(dialog){
                      document.querySelector('#buttonFileChooser').addEventListener('click', () => {
                        const media_radio = document.querySelector('#media-path');
                        const iternal_radio = document.querySelector('#iternal-path');
                        if(media_radio.checked){
                          callback(media_directory + "KML/", layerID);
                        }
                        else if (iternal_radio.checked){
                          callback(root_directory + pathToKMLStorage, layerID);
                        }
                        hideDialog('choose-path-to-KML');
                      }, false)
                      dialog.show()
                  })
        }


        function showActionSheet(element, event){
          event.stopPropagation()
          var layerID = element.getAttribute("layer_id")
          const layer = findLayer(layerID);
          ons.openActionSheet({
            cancelable: true,
            buttons: [
              {
                label: 'Список атрибутов',
                modifier: 'destructive'
              },
              {
                label: 'Экспорт kml',

              },
              {
                label: 'Импорт kml',
              },
              {
                label: 'Очистить слой'
              },
              {
                label: 'Назад',
                icon: 'md-close'
              }
            ]
          }).then(function (index) {
              if(index == 0){
                document.querySelector('#myNavigator').pushPage('./views/features.html', {data: {layerID: layerID}});
              }
              if(index == 1){
                if(!layer.enabled){
                  ons.notification.alert({title:"Внимание", message: "Этот слой нельзя экспортировать"});
                }
                else{
                  createFileChooserForKML(layerID, exportKML);
                }
              }
              if(index == 2){
                createFileChooserForKML(layerID, chooseFile);
              }
              if(index == 3){
                clearLayer(layerID)
              }
            });
        }

        function chooseFile(pathToKML, layerID){
          ons.createElement('file_chooser', {append: true})
            .then(function(dialog){
              let content = document.getElementById('dialog-file-chooser-content')
              showAllFilesAtDir(pathToKML, function(entries){
                let html = ''
                for(let entry of entries){
                  if(entry.name.search(`.xml`)){
                    var item = ons._util.createElement("<ons-list-item tappable></ons-list-item>")
                    item.innerHTML = `${entry.name}`
                    item.addEventListener("click", () => {
                      hideDialog('file-chooser')
                      compareAtribs(layerID, entry.nativeURL)
                    }, false)
                    content.appendChild(item)
                  }
                }
              })
              dialog.show()
            })
        }

        function compareAtribs(layerID, pathToKML){
          let layer = findLayer(layerID)
          openFile(pathToKML, function(data){
              let format = new ol.format.KML()
/*
              data = data.replace(/nan/g, "0")
              const array = [...data.matchAll(/\d*.\d*,\d*.\d*,(\d*.\d*)/g)];
              for(let elem of array){
                data = data.replace(elem[1], 0)
              }*/

              let features = format.readFeatures(data.replace(/nan/g, "0"))
              if(features.length == 0){
                  ons.notification.alert({title:"Внимание", message:'Элементы не найдены'})
                  return
              }
              let properties = features[0].getProperties()
              ons.createElement('comparison_KML', {append: true})
                  .then(function(dialog){
                      let html = '<table>'
                      for(let atrib of layer.atribs){
                          html += `<tr class='property'>
                              <td class='left_property title'>${atrib.name}</td>`

                          let select = `<ons-select class='right_property' id='${atrib.name}' onclick="simpleCreateModalSelect('${atrib.name}')">`
                          select += `<option value="" selected disabled hidden>Нет соотвествия</option>`
                          for(var prop in properties){
                              let selected = ''
                              if(atrib.name.toLowerCase() == prop.toLowerCase()){
                                  selected = ` selected="selected" `
                              }
                              select += `<option value='${prop}'${selected}>${prop}</option>`
                          }
                          select += `</ons-select>`

                          html += `<td>${select}</td>
                              </tr>`
                      }
                      html += `</table>`
                      document.querySelector('#dialog-list-properties').innerHTML = html
                      document.querySelector('#acceptImportKML').addEventListener('click', () => {acceptImportKML(layerID, features)}, false)
                      dialog.show()
                  })
          })
        }

        function acceptImportKML(layerID, features){
          let dict = {}
          let htmlProperties = document.querySelectorAll('.property')
          for(let elem of htmlProperties){
            let left = elem.querySelector('.left_property').textContent
            let right = elem.querySelector('.right_property').value
            dict[left] = right.toLowerCase();
          }
          importKML(layerID, dict, features)
          hideDialog('comparison-KML')
        }

        function clearLayer(layerID){
          let layer = findLayer(layerID)
          ons
          .notification.confirm({title: 'Очистка слоя', messageHTML: `<p class="notification-alert">Вы уверены, что хотите очитстить слой ${layer.label}?</p>`, buttonLabels: ["Нет", "Да"]})
          .then(function(index) {
              if(index == 1){
                let query = `DELETE FROM ${layer.id}`
                requestToDB(query, function(res){
                  layer.getSource().clear(true)
                  ons.notification.alert({title:"Внимание", message:`Слой ${layer.label} очищен`})
                  saveDB()
                })
              }
          });

        }

        function clickRasterMenu(event){
          event.stopPropagation()
          showRasterSheet()
        }



      Sortable.create(layerListWithHandle, {
        handle: '.reorder-move',
        animation: 150,
        onUpdate: function(event){
          var count = layers.length
          for(layerID of this.toArray()){
            let layer = findLayer(layerID)
            layer.setZIndex(count)
            count--
          }
        }
      });

    </script>
</ons-page>