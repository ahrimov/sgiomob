<ons-page>
    <ons-toolbar>
      <div class="left">
        <ons-toolbar-button>
            <ons-back-button>Back</ons-back-button>
        </ons-toolbar-button>
      </div>
      <div class="center">
        Слои
      </div>
    </ons-toolbar>

    <div id="layerListWithHandle" class="list-group">
    </div>

    <ons-list-item expandable>
      <span class="layers-label">Карта OSM</span>
      <div class="expandable-content">
        <ons-switch id="raster-layer-switch"></ons-switch>
          Использовать локальные тайлы
          </br>
          <ons-switch id="raster-layer-switch-visible"></ons-switch>
          <span>Показывать подложку</span>
        </div>
    </ons-list-item>

    <template id="layerListItem">
      <div class="list-group-item" onclick="changeVisible(this)">
        <ons-icon icon="md-reorder" class="reorder-move" size="150%"></ons-icon>
            <span class="layers-label"></span>
            <ons-button modifier="quiet" class="layers-more-button" onclick="showActionSheet(this, event)">
              <ons-icon icon='md-more-vert'></ons-icon>
            </ons-button>
        </div>
    </template>

    <template id="file_chooser">
      <ons-dialog id="file-chooser">
              <ons-toolbar class="dialog-toolbar">
                  <div class="center dialog-toolbar-content">
                      Выберите файл KML
                  </div>
                  <div class="right">
                      <ons-toolbar-button onclick="hideDialog('file-chooser')">
                          <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                      </ons-toolbar-button>
                  </div>
              </ons-toolbar>
              <div> 
              <ons-list id="dialog-file-chooser-content">
              </ons-list>
              </div>
      </ons-dialog>
  </template>

  <template id="comparison_KML">
    <ons-dialog id="comparison-KML">
            <ons-toolbar class="dialog-toolbar">
                <div class="center dialog-toolbar-content">
                    Сопоставление атрибутов
                </div>
                <div class="right">
                    <ons-toolbar-button onclick="hideDialog('comparison-KML')">
                        <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>
            <div id="dialog-comparison-KML-content">
                <p>Соотнесите служебные имена характеристик в левой части (атрибуты из панели свойств)
                     и имена характеристик в правой (полученные из импортируемого Вами файла)</p>
                <div id="dialog-list-properties">
                </div>
                <ons-button modifier="quiet" id="acceptImportKML" style="float:right;">Применить</ons-button>
                <ons-button modifier="quiet" onclick="hideDialog('comparison-KML')" style="float:right;">Отмена</ons-button>
            </div>
    </ons-dialog>
</template>

    <script>
      var app = {}
        ons.getScriptPage().onInit = function() {
          var list = document.querySelector("#layerListWithHandle")
          var template = document.querySelector('#layerListItem')
          layers.sort(function(a, b){
            return b.getZIndex() - a.getZIndex()
          })
          for(layer of layers){
            let label = clipping(layer.label, 30)
            
            var item = template.content.cloneNode(true)
            item.querySelector('.layers-label').textContent = label
            item.querySelector('.list-group-item').setAttribute("data-id", layer.id)
            item.querySelector('.layers-more-button').setAttribute("layer_id", layer.id)
            if(layer.visible){
              item.querySelector('.list-group-item').style.backgroundColor = '#2375fa'
            }
            list.appendChild(item)
          }

          if(typeof localSource == 'undefined'){
            document.querySelector('#raster-layer-switch').setAttribute('disabled', 'true')
          }

          if(raster.isLocal){
            document.querySelector('#raster-layer-switch').setAttribute('checked', 'true')
          }
              
          document.querySelector('#raster-layer-switch').addEventListener('change', function(){
            raster.isLocal = !raster.isLocal
            if(raster.isLocal){
              raster.setSource(localSource)
            }
            else{
              raster.setSource(new ol.source.OSM({}))
            }
            updateInfo()
          })

          if(raster.visible){
            document.querySelector('#raster-layer-switch-visible').setAttribute('checked', 'true')
          }

          document.querySelector('#raster-layer-switch-visible').addEventListener('change', function(){
            raster.visible = !raster.visible
            raster.setVisible(raster.visible)
          })
        }

        function changeVisible(element){
          var layerID = element.getAttribute("data-id")
          for(layer of layers){
            if(layer.id == layerID){
              layer.visible = !layer.visible
              layer.setVisible(layer.visible)
              if(layer.visible){
                element.style.backgroundColor = '#2375fa'
              }
              else{
                element.style.backgroundColor = '#FFFFFF'
              }
            }
          }
        }

        function changeRasterVisible(element){
          raster.visible = !raster.visible
          raster.setVisible(raster.visible)
          if(raster.visible){
            element.style.backgroundColor = '#2375fa'
          }
          else{
            element.style.backgroundColor = '#FFFFFF'
          }
        }


        function showActionSheet(element, event){
          event.stopPropagation()
          var layerID = element.getAttribute("layer_id")
          ons.openActionSheet({
            cancelable: true,
            buttons: [
              {
                label: 'Список атрибутов',
                modifier: 'destructive'
              },
              {
                label: 'Экспорт kml',
              },
              {
                label: 'Импорт kml',
              },
              {
                label: 'Очистить слой'
              },
              {
                label: 'Назад',
                icon: 'md-close'
              }
            ]
          }).then(function (index) {
              if(index == 0){
                document.querySelector('#myNavigator').pushPage('./views/features.html', {data: {layerID: layerID}});
              }
              if(index == 1){
                exportKML(layerID)
              }
              if(index == 2){
                chooseFile(layerID)
              }
              if(index == 3){
                clearLayer(layerID)
              }
            });
        }

        function chooseFile(layerID){
          ons.createElement('file_chooser', {append: true})
            .then(function(dialog){
              let content = document.getElementById('dialog-file-chooser-content')
              showAllFilesAtDir(root_directory + pathToKMLStorage, function(entries){
                let html = ''
                for(let entry of entries){
                  if(entry.name.search(`.xml`)){
                    var item = ons._util.createElement("<ons-list-item tappable></ons-list-item>")
                    item.innerHTML = `${entry.name}`
                    item.addEventListener("click", () => {
                      hideDialog('file-chooser')
                      compareAtribs(layerID, entry.nativeURL)
                    }, false)
                    content.appendChild(item)
                  }
                }
              })
              dialog.show()
            })
        }

        function compareAtribs(layerID, pathToKML){
          let layer = findLayer(layerID)
          openFile(pathToKML, function(data){
              let format = new ol.format.KML()
              let features = format.readFeatures(data)
              if(features.length == 0){
                  ons.notification.alert('Элементы не найдены')
                  return
              }
              let properties = features[0].getProperties()
              ons.createElement('comparison_KML', {append: true})
                  .then(function(dialog){
                      let html = '<table>'
                      for(let atrib of layer.atribs){
                          html += `<tr class='property'>
                              <td class='left_property title'>${atrib.name}</td>`

                          let select = `<ons-select class='right_property' id='${atrib.name}'>`
                          select += `<option value="" selected disabled hidden>Нет соотвествия</option>`
                          for(var prop in properties){
                              let selected = ''
                              if(atrib.name == prop){
                                  selected = ` selected="selected" `
                              }
                              select += `<option value='${prop}'${selected}>${prop}</option>`
                          }
                          select += `</ons-select>`

                          html += `<td>${select}</td>
                              </tr>`
                      }
                      html += `</table>`
                      document.querySelector('#dialog-list-properties').innerHTML = html
                      document.querySelector('#acceptImportKML').addEventListener('click', () => {acceptImportKML(layerID, features)}, false)
                      dialog.show()
                  })
          })
        }

        function acceptImportKML(layerID, features){
          let properties = {}
          let htmlProperties = document.querySelectorAll('.property')
          for(let elem of htmlProperties){
            let left = elem.querySelector('.left_property').textContent
            let right = elem.querySelector('.right_property').value
            properties[left] = right
          }
          importKML(layerID, properties, features)
          hideDialog('comparison-KML')
        }

        function clearLayer(layerID){
          let layer = findLayer(layerID)
          ons
          .notification.confirm({title: 'Очистка слоя', message: `Вы уверены, что хотите очитстить слой ${layer.label}?`})
          .then(function(index) {
              if(index == 1){
                let query = `TRUNCATE TABLE ${layer.id}`
                requestToDB(query, function(res){
                  layer.getSource().clear(true)
                  ons.notification.alert(`Слой ${layer.label} очищен`)
                  //saveDB()
                })
              }
          });

        }

        function clickRasterMenu(event){
          event.stopPropagation()
          showRasterSheet()
        }



      Sortable.create(layerListWithHandle, {
        handle: '.reorder-move',
        animation: 150,
        onUpdate: function(event){
          var count = layers.length
          for(layerID of this.toArray()){
            let layer = findLayer(layerID)
            layer.setZIndex(count)
            count--
          }
        }
      });

    </script>
</ons-page>