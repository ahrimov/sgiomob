<ons-page>
    
    <ons-toolbar>
    <div class="left">
        
        <ons-toolbar-button id='side-menu-button' onclick="fn.openMenu()"> 
        <ons-icon icon="md-menu"></ons-icon>
        </ons-toolbar-button>
        
    </div>
    <div class="center">
        Карта
    </div>

    <div class="right">
        <ons-toolbar-button id="layers-button">
            <ons-icon icon="md-layers"></ons-icon>
        </ons-toolbar-button>
    </div>
    </ons-toolbar>

    <img class='crosshair' src='../resources/crosshair.png'>
    <div id="map-container"></div>

    <ons-carousel overscrollable auto-scroll direction="horizontal" item-width="180px" swipeable id="draw-bar" class="downbar"></ons-carousel>

    <ons-carousel overscrollable auto-scroll direction="horizontal" item-width="180px" swipeable id="draw-instrument-bar" class="downbar">
        <ons-carousel-item>
            <ons-button modifier="quiet" class="carousel-item-content" id="instrument-draw-center" onclick="drawInstrumentCenter()">
                <p class="button-signature">Центр карты</p>
            </ons-button>
        </ons-carousel-item>
        <ons-carousel-item>
            <ons-button modifier="quiet" class="carousel-item-content" id="intrument-draw-gps" onclick="drawInstrumentGPS()">
                <p class="button-signature">Местонахождение устройства</p>
            </ons-button>
        </ons-carousel-item>
        <ons-carousel-item>
            <ons-button modifier="quiet" class="carousel-item-content" id="instrument-draw-coordinate" onclick="showDrawInstrumentDialog()">
                <p class="button-signature">Координаты</p>
            </ons-button>
        </ons-carousel-item>
    </ons-carousel>

    <template id="carousel-item">
        <ons-carousel-item>
            <ons-button class="carousel-item-content" modifier="quiet">
            </ons-button>
          </ons-carousel-item>
    </template>

    <template id="dialog_features">
        <ons-dialog id="dialog-features">
                <ons-toolbar class="dialog-toolbar">
                    <div class="center dialog-toolbar-content">
                        Выбранные элементы
                    </div>
                    <div class="right">
                        <ons-toolbar-button onclick="hideDialog('dialog-features')">
                            <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                        </ons-toolbar-button>
                    </div>
                </ons-toolbar>
                <div > 
                <ons-list id="dialog-features-content">
                </ons-list>
                </div>
        </ons-dialog>
    </template>

    <template id="dialog_draw_instrument_coordinate">
        <ons-dialog id="dialog-draw-instrument-coordinate">
            <ons-toolbar class="dialog-toolbar">
                <div class="center dialog-toolbar-content">
                    Координаты
                </div>
                <div class="right">
                    <ons-toolbar-button onclick="hideDialog('dialog-draw-instrument-coordinate')">
                        <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>
            <div class="dialog-draw-instrument-coordinate-content">
                <p>Введите координаты</p>
                <div>
                    <span>Y:</span>
                    <ons-input id="Y-value" modifier="underbar" type="number" float value="0"></ons-input>
                </div>
                <div>
                    <span>X:</span>
                    <ons-input id="X-value" modifier="underbar" type="number" float value="0"></ons-input>
                </div>
                <ons-button modifier="quiet" onclick="drawInstrumentCoordinate()" style="float:right;">Установить</ons-button>
                <ons-button modifier="quiet" onclick="hideDialog('dialog-draw-instrument-coordinate')" style="float:right;">Отмена</ons-button>
            </div>
        </ons-dialog>
    </template>

    <script>
    ons.getScriptPage().onInit = function() {
        showMap()
        createDrawBar()

        this.querySelector('#layers-button').onclick = function() {
            document.querySelector('#myNavigator').pushPage('./views/layers.html');
        };

        this.onShow = function() { 
            map.updateSize();
        };
    };

    function homeDisableButtons(){
        document.querySelector('#layers-button').disabled = true
        document.querySelector('#side-menu-button').disabled = true
    }

    function homeEnableButton(){
        document.querySelector('#layers-button').disabled = false
        document.querySelector('#side-menu-button').disabled = false
    }

    function openFeatureProperties(feature){
        hideDialog('dialog-features')
        document.querySelector('#myNavigator').pushPage('./views/featureProperties.html', {data: {feature: feature}});
    }

    function showDialogFeatures(evt){
        let features = map.getFeaturesAtPixel(evt.pixel, {hitTolerance: globalHitTolerance})
        if(features.length == 0){
            return
        }
        if(features.length == 1){
            openFeatureProperties(features[0])
            return
        }
        ons.createElement('dialog_features', {append: true})
            .then(function(dialog){
                let content = document.getElementById('dialog-features-content')
                let list = ''
                for(layer of layers){
                    for(feature of features){
                        if(layer.id == feature.layerID){
                            var header = ons._util.createElement("<ons-list-header></ons-list-header>")
                            header.innerHTML = layer.label
                            content.appendChild(header)
                            for(let feature of features){
                                if(feature.layerID == layer.id){
                                    var item = ons._util.createElement("<ons-list-item tappable></ons-list-item>")
                                    item.innerHTML = `Элемент: ${feature.id}`
                                    item.addEventListener("click", () => openFeatureProperties(feature), false)
                                    content.appendChild(item)
                                }
                            }
                            break
                        }
                    }
                }
                dialog.show()
            })
    }

    function openDrawBar(){
        let mapContainer = document.querySelector('#map-container')
        let drawBar = document.querySelector('#draw-bar')
        mapContainer.style['height'] = "90%"
        drawBar.style["display"] = "block"
        map.updateSize();
        document.querySelector('.crosshair').style['top'] = '45%';
        /*let page = document.querySelector('#myNavigator').topPage;
        page.onDeviceBackButton = function(event){
            //event.preventDefault();
            closeDrawBar();
        }*/
        //document.querySelector('#myNavigator').onDeviceBackButton.enable();
    }

    function closeDrawBar(){
        let mapContainer = document.querySelector('#map-container')
        let drawBar = document.querySelector('#draw-bar')
        mapContainer.style['height'] = "100%"
        drawBar.style["display"] = "none"
        map.updateSize();
        document.querySelector('.crosshair').style['top'] = '50%';
        //document.querySelector('#myNavigator').onDeviceBackButton.destroy();
    }

    function createDrawBar(){
        let drawBar = document.querySelector('#draw-bar')
        for(let layer of layers){
            let template = document.querySelector('#carousel-item')
            let carouselItem = template.content.cloneNode(true)
            carouselItem.querySelector('.carousel-item-content').innerHTML = layer.label
            carouselItem.querySelector('.carousel-item-content').addEventListener('click', function(){

                let drawButton = document.querySelector('.draw-button')
                drawButton.style['display'] = 'none'
                let acceptDrawButton = document.querySelector('.accept-draw-button')
                acceptDrawButton.style['display'] = 'block'

                let fabAcceptDrawButton = document.querySelector('.accept-draw-button-fab')
                fabAcceptDrawButton.setAttribute('disabled', 'true')
                

                drawBar.style['display'] = 'none'
                let drawInstrumentBar = document.querySelector('#draw-instrument-bar')
                drawInstrumentBar.style['display'] = 'block'

                addDrawInteraction(layer)
            })
            drawBar.appendChild(carouselItem)
        }
    }

    function drawInstrumentCenter(){
        appendCoordinate(map.getView().getCenter())
    }

    function drawInstrumentGPS(){
        let coordinate = ol.proj.fromLonLat([gps_position.coords.longitude, gps_position.coords.latitude])
        map.getView().setCenter(coordinate)
        
        appendCoordinate(coordinate)
    }

    function showDrawInstrumentDialog(){
        ons.createElement('dialog_draw_instrument_coordinate', {append: true})
            .then(function(dialog){
                dialog.show()
            })
    }

    function drawInstrumentCoordinate(){
        let y = document.querySelector('#Y-value').value
        let x = document.querySelector('#X-value').value
        if(y < -90 || y > 90 || x > 180 || x < -180){
            ons.notification.alert({title:"Внимание", message:'Недопустимые значения координат'})
            return
        }
        hideDialog('dialog-draw-instrument-coordinate')
        appendCoordinate(ol.proj.fromLonLat([x, y]))
        map.getView().setCenter(ol.proj.fromLonLat([x, y]))
    }

    function hideDialog(id){
        let dialog = document.getElementById(id)
        if(dialog){
            dialog.remove()
        }
    }

    </script>
</ons-page>