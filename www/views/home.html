<ons-page>
    
    <ons-toolbar>
    <div class="left">
        
        <ons-toolbar-button onclick="fn.openMenu()"> 
        <ons-icon icon="md-menu"></ons-icon>
        </ons-toolbar-button>
        
    </div>
    <div class="center">
        Карта
    </div>

    <div class="right">
        <ons-toolbar-button id="push">
            <ons-icon icon="md-layers"></ons-icon>
        </ons-toolbar-button>
    </div>
    </ons-toolbar>

    <div id="map-container"></div>

    <ons-carousel overscrollable auto-scroll direction="horizontal" item-width="150px" swipeable id="draw-bar" class="downbar">
    </ons-carousel>

    <ons-carousel overscrollable auto-scroll direction="horizontal" item-width="150px" swipeable id="draw-instrument-bar" class="downbar">
        <ons-carousel-item>
            <div class="carousel-item-content" id="instrument-draw-center" onclick="drawInstrumentCenter()">
                Центр карты
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="intrument-draw-gps">
                Местонахождение устройства
            </div>
        </ons-carousel-item>
        <ons-carousel-item>
            <div class="carousel-item-content" id="instrument-draw-coordinate">
                Координаты
            </div>
        </ons-carousel-item>
    </ons-carousel>

    <template id="carousel-item">
        <ons-carousel-item>
            <div class="carousel-item-content">
            </div>
          </ons-carousel-item>
    </template>

    <template id="dialog_features">
        <ons-dialog id="dialog-features">
                <ons-toolbar class="dialog-toolbar">
                    <div class="center dialog-toolbar-content">
                        Выбранные элементы
                    </div>
                    <div class="right">
                        <ons-toolbar-button onclick="hideDialog('dialog-features')">
                            <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                        </ons-toolbar-button>
                    </div>
                </ons-toolbar>
                <div > 
                <ons-list id="dialog-features-content">
                </ons-list>
                </div>
        </ons-dialog>
    </template>

    <script>
    ons.getScriptPage().onInit = function() {
        showMap()
        createDrawBar()

        this.querySelector('#push').onclick = function() {
            document.querySelector('#myNavigator').pushPage('./views/layers.html');
        };

        this.onShow = function() { 
            map.updateSize();
        };
    };

    function openFeatureProperties(feature){
        hideDialog('dialog-features')
        document.querySelector('#myNavigator').pushPage('./views/featureProperties.html', {data: {layerID: feature.layerID, featureID: feature.id}});
    }

    function showDialogFeatures(evt){
        let features = map.getFeaturesAtPixel(evt.pixel)
        if(features.length == 0){
            return
        }
        if(features.length == 1){
            openFeatureProperties(features[0])
            return
        }
        ons.createElement('dialog_features', {append: true})
            .then(function(dialog){
                let content = document.getElementById('dialog-features-content')
                let list = ''
                for(layer of layers){
                    for(feature of features){
                        if(layer.id == feature.layerID){
                            var header = ons._util.createElement("<ons-list-header></ons-list-header>")
                            header.innerHTML = layer.label
                            content.appendChild(header)
                            for(let feature of features){
                                if(feature.layerID == layer.id){
                                    var item = ons._util.createElement("<ons-list-item tappable></ons-list-item>")
                                    item.innerHTML = `Элемент: ${feature.id}`
                                    item.addEventListener("click", () => openFeatureProperties(feature), false)
                                    content.appendChild(item)
                                }
                            }
                            break
                        }
                    }
                }
                dialog.show()
            })
    }

    function openDrawBar(){
        let mapContainer = document.querySelector('#map-container')
        let drawBar = document.querySelector('#draw-bar')
        mapContainer.style['height'] = "85%"
        drawBar.style["display"] = "block"
    }

    function closeDrawBar(){
        let mapContainer = document.querySelector('#map-container')
        let drawBar = document.querySelector('#draw-bar')
        mapContainer.style['height'] = "100%"
        drawBar.style["display"] = "none"
    }

    function createDrawBar(){
        let drawBar = document.querySelector('#draw-bar')
        for(let layer of layers){
            let template = document.querySelector('#carousel-item')
            let carouselItem = template.content.cloneNode(true)
            carouselItem.querySelector('.carousel-item-content').innerHTML = layer.label
            carouselItem.querySelector('.carousel-item-content').addEventListener('click', function(){

                let drawButton = document.querySelector('.draw-button')
                drawButton.style['display'] = 'none'
                let acceptDrawButton = document.querySelector('.accept-draw-button')
                acceptDrawButton.style['display'] = 'block'

                drawBar.style['display'] = 'none'
                let drawInstrumentBar = document.querySelector('#draw-instrument-bar')
                drawInstrumentBar.style['display'] = 'block'

                addDrawInteraction(layer)
            })
            drawBar.appendChild(carouselItem)
        }
    }

    function drawInstrumentCenter(){
        drawNextPoint(currentMapView.getCenter())
    }

    function hideDialog(id){
        let dialog = document.getElementById(id)
        if(dialog){
            dialog.remove()
        }
    }

    </script>
</ons-page>