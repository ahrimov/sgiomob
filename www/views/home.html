<ons-page>
    <ons-toolbar>
    <div class="left">
        
        <ons-toolbar-button> <!-- use onclick="fn.openMenu()" --> 
        <ons-icon icon="md-menu"></ons-icon>
        </ons-toolbar-button>
        
    </div>
    <div class="center">
        Карта
    </div>

    <div class="right">
        <ons-toolbar-button id="push">
            <ons-icon icon="md-layers"></ons-icon>
        </ons-toolbar-button>
    </div>
    </ons-toolbar>

    <div id="map-container"></div>

    <template id="dialog_features">
        <ons-dialog id="dialog-features">
                <ons-toolbar class="dialog-toolbar">
                    <div class="center dialog-toolbar-content">
                        Выбранные элементы
                    </div>
                    <div class="right">
                        <ons-toolbar-button onclick="hideDialog('dialog-features')">
                            <ons-icon icon="md-close" class="dialog-close"></ons-icon>
                        </ons-toolbar-button>
                    </div>
                </ons-toolbar>
                <div > 
                <ons-list id="dialog-features-content">
                </ons-list>
                </div>
        </ons-dialog>
    </template>

    <script>
    ons.getScriptPage().onInit = function() {
        showMap()
        this.querySelector('#push').onclick = function() {
            document.querySelector('#myNavigator').pushPage('./views/layers.html');
        };
        this.onShow = function() { 
        };
    };

    function openFeatureProperties(feature){
        var dialog = document.getElementById('dialog-features')
        if(dialog){
            dialog.remove()
        }
        document.querySelector('#myNavigator').pushPage('./views/featureProperties.html', {data: {layerID: feature.layerID, featureID: feature.id}});
    }

    function showDialogFeatures(evt){
        let features = map.getFeaturesAtPixel(evt.pixel)
        console.log(features.length)
        if(features.length == 0){
            return
        }
        if(features.length == 1){
            openFeatureProperties(features[0])
            return
        }
        ons.createElement('dialog_features', {append: true})
            .then(function(dialog){
                let content = document.getElementById('dialog-features-content')
                let list = ''
                for(layer of layers){
                    for(feature of features){
                        if(layer.id == feature.layerID){
                            var header = ons._util.createElement("<ons-list-header></ons-list-header>")
                            header.innerHTML = layer.label
                            content.appendChild(header)
                            for(let feature of features){
                                if(feature.layerID == layer.id){
                                    var item = ons._util.createElement("<ons-list-item tappable></ons-list-item>")
                                    item.innerHTML = `Элемент: ${feature.id}`
                                    item.addEventListener("click", () => openFeatureProperties(feature), false)
                                    content.appendChild(item)
                                }
                            }
                            break
                        }
                    }
                }
                dialog.show()
            })
    }

    function hideDialog(id){
        document.getElementById(id).remove()
    }

    </script>

    <style>
        .dialog-toolbar{
            background-color: #2375fa;
        }
        .dialog-toolbar-content{
            font-size: 12pt;
            color: white;
        }
        .dialog-close{
            color: white;
        }
        #dialog-features-content{
            margin-top: 10vh;
            max-height: 70vh;
            overflow: scroll;
        }
    </style>
</ons-page>